## 【数字音频】DAW 软件的速度自动化

日期：2022-03-11

很多 DAW 软件都带有自动化的功能，但不同软件对速度自动化的实现方式和效果却不尽相同。本文章是笔者对于这些软件实现效果的记录，以及对于实现方式的反推。

本文章的表述和用语并不严谨。望请各位斧正。

### 问题 1

一段音频片段有四拍，第一拍开始时的速度为 120 bpm（拍/分钟），第四拍结束时的速度为 60 bpm，速度与节拍时间满足线性关系。这四拍对应的实际时间是多少？

对上面这个问题进行相对一般的表述，得到的问题如下：
已知音频某个时间点的速度 $v$ 与节拍 $t$ 满足函数 $v = v(t)$。求从某一拍 ${t_1}$ 到另一拍 ${t_2}$ 所经历的实际时间。

### 不就是定积分么

计算时间的方式很简单。设经历的实际时间为 $T$，则有$(1)$

$$
\begin{aligned}
T=\int_{t_1}^{t_2}\frac{dt}{v(t)}
\end{aligned}
$$

其中，$v$ 的单位为 bpm，$T$ 的单位为 min。

回到开始的问题，可得

$$
\begin{cases}
v(t)=-15t+120 \\
{t_1}=0 \\
{t_2}=4
\end{cases}
$$

代入（1）得

$$
\begin{aligned}
T&=\int_0^4\frac{dt}{-15t+120} \\
 &=\frac{\ln|-15x+120|}{-15}\biggm\vert
\begin{matrix}
4 \cr
0
\end{matrix} \\
 &=\frac{\ln60-\ln120}{-15} \\
 &=\frac{\ln2}{15}
\end{aligned}
$$

经历的实际时间为 $\frac{\ln2}{15}$ min，即 $4{\ln2}$ s，约为 2.772 s。
设采样率为 44100 Hz，则经历的采样数为 $176400 \ln2\approx$ 122271。

### 形态各异的软件实现

如果只停留在数学计算上，事情很完美。然而实际上不同的 DAW 软件算出的值与我们算出的值会有一些偏差。我们按照最开始问题的描述，在软件的主轨道中绘制自动化包络，选中相应片段，导出一个 44100 Hz 的音频文件，得到的结果如下：

| 软件名          | 音频文件的采样数 | 与预期采样数的偏差 | PPQ |
| :-------------- | :--------------- | :----------------- | :-- |
| FL Studio 20    | 122156           | -115               | 96  |
| Ableton Live 11 | 119481           | -2790              | 96  |
| Cubase 11       | 122272           | 1                  | 480 |
| REAPER 6.49     | 117600           | -4671              | 96  |

我手头没有更多的 DAW 软件，只能测出以上的这些值。就这些值看来，只有 Cubase 的准确性最好。但问题是，为什么这些软件计算的值不一样？

各位应该注意到了最后一列，其中列出了我在导出片段时软件的 PPQ 值。**PPQ**（或 PPQN）为 pulse per quarter (note) 的简写，意为**每四分音符脉冲数**，代表了软件中 MIDI 时钟的精度。
关于 PPQ 值的设置，各个软件的情况也不尽相同：
FL Studio 的默认 PPQ 值为 96，可以调整为几个固定值；
Ableton Live 的默认 PPQ 值为 96，无法调整；
REAPER 的默认 PPQ 值为 96，可以相对自由地调整；
Cubase 的默认 PPQ 值为 480，最低为 240，最高为 4000。

这些软件的 PPQ 无法调为一致的值，因此无法严格地控制变量。我不是很清楚这些软件计算时间的功能是否与 PPQ 有直接关系，因此仍需进一步的探究。

### 问题 2-1

一个音频片段有 $\frac{1}{4}$ 拍，开始时的速度为 30 bpm，结束时的速度为 180 bpm，速度与节拍时间满足线性关系。这一音频片段的长度是多少？

同样通过开始的计算方式得出，长度为 $\frac{\ln180-\ln30}{600}$ min = $\frac{\ln180-\ln30}{10}$ s $\approx$ 0.179 s。设音频采样率为 44100Hz，则采样数为 $4410(\ln180-\ln30)\approx$ 7902。

在不同软件中按照上题条件绘制速度自动化，导出的音频文件仍为 44100 Hz。得到的结果如下：

| 软件名          | 音频文件的采样数 | 与预期采样数的偏差 | PPQ |
| :-------------- | :--------------- | :----------------- | :-- |
| FL Studio 20    | 5906             | -1996              | 96  |
| Ableton Live 11 | 22050            | 14148              | 96  |
| Cubase 11       | 7902             | 0                  | 480 |
| REAPER 6.49     | 6048             | -1854              | 96  |

测试的软件中，Cubase 依旧不负众望，在时间计算方面的准确性吊打其他软件。
除此之外，其中一个数据吸引了我的注意：在 Ableton Live 11 中绘制速度自动化，得到的结果是 22050 采样，即 0.5 s。这个值正好是以 30 bpm 的恒定速度下的 $\frac{1}{4}$ 拍的长度。或许 Ableton Live 直接是直接算 30 bpm 下 $\frac{1}{4}$ 拍的长度？带着这一疑问，我觉得可以把问题 2-1 反过来再试一次。

### 问题 2-2

一个音频片段有 $\frac{1}{4}$ 拍，开始时的速度为 180 bpm，结束时的速度为 30 bpm，速度与节拍时间满足线性关系。这一音频片段的长度是多少？

如果之前对 Live 的猜测成立的话，那么这次 Live 得出的结果是 180 bpm 下 $\frac{1}{4}$ 拍的长度，即 $\frac{1}{12}$ s。设采样率为 44100 Hz，则结果为 3675 采样。

在 Live 中绘制相应的速度自动化，导出的音频文件采样率为 44100 Hz。结果得到的音频文件长度恰好为 3675 采样。因此可以认为 Live 会在节拍长度或者节拍对应的实际时间较短时简化计算方式。经过进一步的实验以及结果记录，目前得出的结论如下：在速度自动化包络存在时，Live 计算实际时间的方式是对每 $\frac{1}{4}$ 拍（16 分音符）在这段时间开始时的速度与 $\frac{1}{4}$ 拍的乘积求和。这种方式是定积分近似计算的一种方法，称为**矩形法**。

Live 这种时间计算的方式在问题 2-1 这种相对极端的情况下暴露出了很大的问题。不过，这种极端情况在实践中出现的可能性貌似并不大。

### 直线变曲线

如果想让自动化包络带曲线。我们还需要思考另一个问题，那就是用什么曲线来绘制包络。

从本文开头我们得知，给定速度自动化，求实际时间的方式是对速度函数取倒，然后求定积分。如果速度包络要带曲线，那么我们要保证取倒后求定积分的过程相对容易。但只有这一点还不够，我们还需要保证绘制自动化包络（图形）的过程相对简单。

#### 画自动化包络的实际场景

在多数 DAW 软件中，自动化包络显示的方式是在两点之间添加一个控制点，用户可以拖动这一控制点，以控制曲线的形状。有些软件（如 FL Studio）会提供多种曲线形状，不过这一点暂时不在我们考虑的范围之内。

两个点之间添加一个控制点。给定这样的绘制方式，二次贝塞尔曲线是目前最合适的选择。

简单介绍以下这种曲线吧。给定两个端点$P_0$，$P_2$，一个控制点$P_1$ 和下面的参数方程：

$$
B(t)=(1-t)^2 P_0+2(1-t)tP_1+t^2 P_2，0\leq t \leq 1
$$

绘制这一参数方程的图象，得出的图象就是一条二次贝塞尔曲线。
![通过端点和控制点得到二次贝塞尔曲线](https://i.stack.imgur.com/CM0cL.jpg)  
图源：[Convert quadratic bezier curve to parabola - Mathematics Stack Exchange](https://math.stackexchange.com/questions/1257576/convert-quadratic-bezier-curve-to-parabola)

我们关心的是它的两条重要性质：

- 它是抛物线的一段。
- 直线 $P_0P_1$ 和 $P_1P_2$ 是对应抛物线的两条切线。

既然二次贝塞尔曲线是抛物线的一段，那么接下来的问题是：已知以上三个点的坐标为$P_0(x_0, y_0)$, $P_1(x_1, y_1)$ 和 $P_2(x_2, y_2)$, 能否求出得出的贝塞尔曲线的函数 $y=f(x)$？

实际上，要得出函数，只需要一个先行条件：

$$
x_1 = \frac{x_0 + x_2}{2}
$$

有了这一条件，我们就可以尝试求函数了。令$(2)$

$$
\begin{aligned}
y=f(x)=ax^2+bx+c
\end{aligned}
$$

对其求导则有$(3)$

$$
\begin{aligned}
y'=f'(x)=2ax+b
\end{aligned}
$$

还记得之前提到的两条切线吗？是时候让它们派上用场了。直线 $P_0P_1$ 的斜率（即$f'(x_0)$）为

$$
f'(x_0)=\frac{y_1-y_0}{x_1-x_0}
$$

直线 $P_1P_2$ 的斜率（即$f'(x_2)$）为

$$
f'(x_2)=\frac{y_2-y_1}{x_2-x_1}
$$

得到上面的两个值后，代入$(3)$，列出二元一次方程组，可解出 $a$ 与 $b$。然后将$a$，$b$ 与 $P_0$ 或 $P_2$ 的坐标代入$(2)$，即可求解出 $c$。

接下来是二次函数的取倒求定积分。二次函数取倒求不定积分的公式如下：

$$
\int \frac{dx}{ax^2+bx+c}=
\begin{cases}
\frac{2}{\sqrt{4ac-b^2}} \arctan \frac{2ax+b}{\sqrt{4ac-b^2}}+C&，b^2\lt4ac \\
\frac{1}{\sqrt{b^2-4ac}} \ln{\vert\frac{2ax+b-\sqrt{b^2-4ac}}{2ax+b+\sqrt{b^2-4ac}}\vert}+C&，b^2\gt4ac \\
\end{cases}
$$

读者应该注意到一点，如果 $b^2=4ac$，那么取倒求积分是做不到的。我们要尝试在软件实现中避免这一情况的出现。实际上要避免也不算太难，在更新点值、更新控制点相关值时检查受影响的点，遇到 $b^2=4ac$ 的情况时，轻微修改控制点相关的值。

